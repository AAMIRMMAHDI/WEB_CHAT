<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>چت</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <link rel="stylesheet" href="https://v1.fontapi.ir/css/Vazir">
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        * {
            font-family: 'Vazir', sans-serif;
        }
        body {
            background: #1a1a1a;
            color: #e0e0e0;
            overflow: hidden;
            height: 100vh;
        }
        .gradient-bg {
            background: linear-gradient(135deg, #1e3a8a, #6b21a8);
            animation: gradient 15s ease infinite;
        }
        @keyframes gradient {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }
        .glass-effect {
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        .message-bubble {
            background: #2d2d2d;
            border-radius: 15px 15px 15px 0;
            transition: transform 0.2s ease;
        }
        .message-bubble:hover {
            transform: translateY(-2px);
        }
        .sidebar-item:hover {
            background: #3b3b3b;
            transform: translateX(5px);
        }
        .modal-content {
            transform: translateY(0);
            transition: transform 0.3s ease;
        }
        .modal-content:hover {
            transform: translateY(-5px);
        }
        .notification {
            animation: fadeInOut 3s ease;
        }
        @keyframes fadeInOut {
            0% { opacity: 0; transform: translateY(-20px); }
            10% { opacity: 1; transform: translateY(0); }
            90% { opacity: 1; transform: translateY(0); }
            100% { opacity: 0; transform: translateY(-20px); }
        }
        #chat-sidebar {
            transition: transform 0.3s ease;
        }
        @media (max-width: 768px) {
            #chat-sidebar {
                position: fixed;
                top: 0;
                right: -100%;
                width: 100%;
                height: 100%;
                z-index: 1000;
            }
            #chat-sidebar.active {
                right: 0;
            }
            .modal-content {
                width: 100%;
                height: 100%;
                border-radius: 0;
                margin: 0;
            }
            .chat-input textarea {
                max-height: 100px;
            }
            .chat-messages {
                padding-bottom: 80px;
            }
        }
    </style>
</head>
<body class="flex flex-col h-screen">
    <div id="auth-container" class="flex items-center justify-center h-screen gradient-bg">
        <div class="glass-effect p-6 rounded-2xl shadow-2xl w-full max-w-sm sm:max-w-md transform transition-all duration-300 hover:scale-105">
            <h2 class="text-2xl sm:text-3xl font-bold text-center text-white mb-6">ورود به چت</h2>
            <input id="username" type="text" placeholder="نام کاربری" class="w-full p-3 mb-4 rounded-lg bg-gray-800 text-white border border-gray-700 focus:outline-none focus:border-indigo-500 text-sm sm:text-base">
            <input id="display_name" type="text" placeholder="نام نمایشی (اختیاری)" class="w-full p-3 mb-4 rounded-lg bg-gray-800 text-white border border-gray-700 focus:outline-none focus:border-indigo-500 text-sm sm:text-base">
            <input id="password" type="password" placeholder="رمز عبور" class="w-full p-3 mb-6 rounded-lg bg-gray-800 text-white border border-gray-700 focus:outline-none focus:border-indigo-500 text-sm sm:text-base">
            <button id="login-btn" class="w-full p-3 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 transition-all duration-200 text-sm sm:text-base">ورود</button>
        </div>
    </div>
    <div id="chat-container" class="hidden flex-1 flex overflow-hidden">
        <div id="chat-sidebar" class="w-full sm:w-80 bg-gray-900 p-4 flex flex-col gap-4">
            <div class="flex justify-between items-center">
                <h2 class="text-lg sm:text-xl font-bold text-white">چت‌ها</h2>
                <button id="close-sidebar" class="sm:hidden text-gray-300 hover:text-white"><i class="fas fa-times"></i></button>
            </div>
            <div class="space-y-2">
                <input id="search-users" type="text" placeholder="جستجوی کاربران..." class="w-full p-2 rounded-lg bg-gray-800 text-white border border-gray-700 focus:outline-none focus:border-indigo-500 text-sm">
                <input id="search-groups" type="text" placeholder="جستجوی گروه‌ها..." class="w-full p-2 rounded-lg bg-gray-800 text-white border border-gray-700 focus:outline-none focus:border-indigo-500 text-sm">
            </div>
            <div class="flex-1 overflow-y-auto space-y-2">
                <div class="accordion flex justify-between items-center p-2 rounded-lg cursor-pointer hover:bg-gray-800" id="groups-accordion">
                    <span>گروه‌ها</span>
                    <i class="fas fa-chevron-down"></i>
                </div>
                <div class="accordion-content" id="groups-content">
                    <div id="groups-list" class="space-y-2"></div>
                </div>
                <div class="accordion flex justify-between items-center p-2 rounded-lg cursor-pointer hover:bg-gray-800" id="profiles-accordion">
                    <span>پروف‌ها</span>
                    <i class="fas fa-chevron-down"></i>
                </div>
                <div class="accordion-content" id="profiles-content">
                    <div id="profiles-list" class="space-y-2"></div>
                </div>
                <div class="accordion flex justify-between items-center p-2 rounded-lg cursor-pointer hover:bg-gray-800" id="search-groups-accordion">
                    <span>نتایج جستجوی گروه‌ها</span>
                    <i class="fas fa-chevron-down"></i>
                </div>
                <div class="accordion-content" id="search-groups-content">
                    <div id="search-groups-list" class="space-y-2"></div>
                </div>
            </div>
            <div class="space-y-2">
                <button id="create-group-btn" class="w-full p-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 text-sm"><i class="fas fa-plus"></i> ایجاد گروه</button>
                <button id="join-group-btn" class="w-full p-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 text-sm"><i class="fas fa-sign-in-alt"></i> پیوستن به گروه</button>
                <button id="profile-btn" class="w-full p-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 text-sm"><i class="fas fa-user"></i> پروفایل</button>
            </div>
        </div>
        <div id="chat-main" class="flex-1 flex flex-col bg-gray-800 rounded-lg sm:m-4 sm:shadow-2xl">
            <div class="chat-header flex justify-between items-center p-4 bg-gray-900 glass-effect rounded-t-lg">
                <div class="flex items-center gap-2">
                    <button id="open-sidebar" class="sm:hidden text-gray-300 hover:text-white"><i class="fas fa-bars"></i></button>
                    <h2 id="current-chat" class="text-lg sm:text-xl font-bold text-white">چت گروهی</h2>
                </div>
                <div class="relative group">
                    <button id="menu-btn" class="text-gray-300 hover:text-white"><i class="fas fa-ellipsis-v"></i></button>
                    <div id="header-menu" class="hidden absolute top-10 right-0 w-48 p-4 bg-gray-900 rounded-lg shadow-xl z-50 group-hover:block">
                        <button id="online-users-btn" class="block w-full text-right p-2 text-white hover:bg-gray-800 rounded"><i class="fas fa-users"></i> کاربران آنلاین</button>
                        <button id="groups-btn" class="block w-full text-right p-2 text-white hover:bg-gray-800 rounded"><i class="fas fa-users-cog"></i> گروه‌ها</button>
                        <button id="profile-header-btn" class="block w-full text-right p-2 text-white hover:bg-gray-800 rounded"><i class="fas fa-user-circle"></i> پروفایل</button>
                    </div>
                </div>
            </div>
            <div class="chat-messages flex-1 p-4 overflow-y-auto bg-gray-800">
                <div id="chat-messages"></div>
            </div>
            <div class="chat-input p-4 bg-gray-900 glass-effect flex items-center gap-2 rounded-b-lg">
                <textarea id="message-input" placeholder="پیام خود را بنویسید..." class="flex-1 p-3 rounded-lg bg-gray-800 text-white border border-gray-700 focus:outline-none focus:border-indigo-500 resize-none text-sm"></textarea>
                <div class="flex gap-2">
                    <button id="emoji-btn" title="اموجی" class="p-2 bg-indigo-600 text-white rounded-full hover:bg-indigo-700"><i class="fas fa-smile"></i></button>
                    <button onclick="document.getElementById('file-input').click()" title="ارسال فایل" class="p-2 bg-indigo-600 text-white rounded-full hover:bg-indigo-700"><i class="fas fa-paperclip"></i></button>
                    <input type="file" id="file-input" multiple style="display: none;">
                    <button id="send-btn" title="ارسال پیام" class="p-2 bg-indigo-600 text-white rounded-full hover:bg-indigo-700"><i class="fas fa-paper-plane"></i></button>
                </div>
            </div>
        </div>
    </div>
    <div id="group-modal" class="modal hidden fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center z-50">
        <div class="modal-content glass-effect p-6 rounded-2xl w-full max-w-sm sm:max-w-md">
            <button class="close-btn absolute top-4 left-4 text-gray-300 hover:text-white text-lg" onclick="closeGroupModal()"><i class="fas fa-times"></i></button>
            <h2 class="text-xl sm:text-2xl font-bold text-white mb-6">ایجاد گروه</h2>
            <input id="group-name" type="text" placeholder="نام گروه" class="w-full p-3 mb-4 rounded-lg bg-gray-800 text-white border border-gray-700 focus:outline-none focus:border-indigo-500 text-sm">
            <textarea id="group-description" placeholder="توضیحات گروه" class="w-full p-3 mb-4 rounded-lg bg-gray-800 text-white border border-gray-700 focus:outline-none focus:border-indigo-500 text-sm"></textarea>
            <input id="group-password" type="password" placeholder="رمز عبور (اختیاری)" class="w-full p-3 mb-4 rounded-lg bg-gray-800 text-white border border-gray-700 focus:outline-none focus:border-indigo-500 text-sm">
            <input id="group-image-input" type="file" accept="image/*" class="w-full p-3 mb-6 rounded-lg bg-gray-800 text-white border border-gray-700 text-sm">
            <button id="save-group-btn" class="w-full p-3 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 text-sm">ایجاد گروه</button>
        </div>
    </div>
    <div id="join-group-modal" class="modal hidden fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center z-50">
        <div class="modal-content glass-effect p-6 rounded-2xl w-full max-w-sm sm:max-w-md">
            <button class="close-btn absolute top-4 left-4 text-gray-300 hover:text-white text-lg" onclick="closeJoinGroupModal()"><i class="fas fa-times"></i></button>
            <h2 class="text-xl sm:text-2xl font-bold text-white mb-6">پیوستن به گروه</h2>
            <input id="join-group-id" type="text" placeholder="شناسه گروه" class="w-full p-3 mb-4 rounded-lg bg-gray-800 text-white border border-gray-700 focus:outline-none focus:border-indigo-500 text-sm">
            <input id="join-group-password" type="password" placeholder="رمز عبور (اگر دارد)" class="w-full p-3 mb-6 rounded-lg bg-gray-800 text-white border border-gray-700 focus:outline-none focus:border-indigo-500 text-sm">
            <button id="join-group-btn-modal" class="w-full p-3 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 text-sm">پیوستن</button>
        </div>
    </div>
    <div id="profile-modal" class="modal hidden fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center z-50">
        <div class="modal-content glass-effect p-6 rounded-2xl w-full max-w-sm sm:max-w-md">
            <button class="close-btn absolute top-4 left-4 text-gray-300 hover:text-white text-lg" onclick="closeProfileModal()"><i class="fas fa-times"></i></button>
            <h2 class="text-xl sm:text-2xl font-bold text-white mb-6">پروفایل</h2>
            <div id="profile-avatar" class="w-24 h-24 sm:w-32 sm:h-32 bg-indigo-600 text-white flex items-center justify-center rounded-full mx-auto mb-4 text-2xl sm:text-4xl"></div>
            <img id="profile-image" alt="تصویر پروفایل" class="w-24 h-24 sm:w-32 sm:h-32 rounded-full mx-auto mb-4 hidden">
            <input id="profile-image-input" type="file" accept="image/*" class="w-full p-3 mb-4 rounded-lg bg-gray-800 text-white border border-gray-700 text-sm">
            <input id="profile-username" type="text" placeholder="نام کاربری" class="w-full p-3 mb-4 rounded-lg bg-gray-800 text-white border border-gray-700 focus:outline-none focus:border-indigo-500 text-sm">
            <input id="profile-display-name" type="text" placeholder="نام نمایشی" class="w-full p-3 mb-4 rounded-lg bg-gray-800 text-white border border-gray-700 focus:outline-none focus:border-indigo-500 text-sm">
            <input id="profile-password" type="password" placeholder="رمز عبور جدید (اختیاری)" class="w-full p-3 mb-6 rounded-lg bg-gray-800 text-white border border-gray-700 focus:outline-none focus:border-indigo-500 text-sm">
            <button id="save-profile-btn" class="w-full p-3 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 text-sm">ذخیره</button>
            <button id="logout-btn" class="w-full p-3 bg-red-600 text-white rounded-lg hover:bg-red-700 mt-2 text-sm">خروج</button>
        </div>
    </div>
    <script>
        let currentUser = '';
        let currentUserId = null;
        let currentTab = 'group';
        let lastMessageId = 0;
        let currentPrivateUserId = null;
        let currentGroupId = null;
        let pollingInterval = null;

        document.addEventListener('DOMContentLoaded', () => {
            const loginBtn = document.getElementById('login-btn');
            const sendBtn = document.getElementById('send-btn');
            const createGroupBtn = document.getElementById('create-group-btn');
            const joinGroupBtn = document.getElementById('join-group-btn');
            const joinGroupBtnModal = document.getElementById('join-group-btn-modal');
            const emojiBtn = document.getElementById('emoji-btn');
            const fileInput = document.getElementById('file-input');
            const profileBtn = document.getElementById('profile-btn');
            const messageInput = document.getElementById('message-input');
            const searchUsers = document.getElementById('search-users');
            const searchGroups = document.getElementById('search-groups');
            const saveProfileBtn = document.getElementById('save-profile-btn');
            const logoutBtn = document.getElementById('logout-btn');
            const profileImageInput = document.getElementById('profile-image-input');
            const openSidebarBtn = document.getElementById('open-sidebar');
            const closeSidebarBtn = document.getElementById('close-sidebar');
            const menuBtn = document.getElementById('menu-btn');
            const headerMenu = document.getElementById('header-menu');

            loginBtn.addEventListener('click', enterChat);
            sendBtn.addEventListener('click', sendMessage);
            createGroupBtn.addEventListener('click', openGroupModal);
            joinGroupBtn.addEventListener('click', () => {
                document.getElementById('join-group-modal').style.display = 'flex';
            });
            joinGroupBtnModal.addEventListener('click', joinGroup);
            emojiBtn.addEventListener('click', toggleEmojiPicker);
            fileInput.addEventListener('change', handleFileSelect);
            profileBtn.addEventListener('click', showProfile);
            saveProfileBtn.addEventListener('click', saveProfile);
            logoutBtn.addEventListener('click', logout);
            profileImageInput.addEventListener('change', handleProfileImageSelect);

            openSidebarBtn.addEventListener('click', () => {
                document.getElementById('chat-sidebar').classList.add('active');
            });

            closeSidebarBtn.addEventListener('click', () => {
                document.getElementById('chat-sidebar').classList.remove('active');
            });

            menuBtn.addEventListener('click', () => {
                headerMenu.classList.toggle('hidden');
            });

            document.getElementById('online-users-btn').addEventListener('click', () => {
                fetchUsers();
                headerMenu.classList.add('hidden');
            });

            document.getElementById('groups-btn').addEventListener('click', () => {
                fetchGroups();
                headerMenu.classList.add('hidden');
            });

            document.getElementById('profile-header-btn').addEventListener('click', () => {
                showProfile();
                headerMenu.classList.add('hidden');
            });

            messageInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    sendMessage();
                }
            });

            searchUsers.addEventListener('input', () => {
                const query = searchUsers.value.trim();
                fetchUsers(query);
            });

            searchGroups.addEventListener('input', () => {
                const query = searchGroups.value.trim();
                fetchGroupSearch(query);
            });

            document.getElementById('groups-accordion').addEventListener('click', () => {
                toggleAccordion('groups-content');
            });
            document.getElementById('profiles-accordion').addEventListener('click', () => {
                toggleAccordion('profiles-content');
            });
            document.getElementById('search-groups-accordion').addEventListener('click', () => {
                toggleAccordion('search-groups-content');
            });
        });

        function toggleAccordion(contentId) {
            const content = document.getElementById(contentId);
            content.classList.toggle('active');
        }

        function toggleEmojiPicker() {
            alert('اموجی‌ها هنوز پیاده‌سازی نشده‌اند!');
        }

        function handleFileSelect(e) {
            const files = e.target.files;
            if (!files.length) return;
            const formData = new FormData();
            Array.from(files).forEach(file => formData.append('files', file));
            fetch('/api/upload/', {
                method: 'POST',
                headers: { 'X-CSRFToken': getCsrfToken() },
                body: formData
            })
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'error') throw new Error(data.message);
                    sendMessageWithFiles(data.file_urls);
                })
                .catch(error => {
                    showNotification(`خطا در آپلود فایل: ${error.message}`, 'error');
                });
        }

        function handleProfileImageSelect(e) {
            const file = e.target.files[0];
            if (!file) return;
            const formData = new FormData();
            formData.append('profile_image', file);
            fetch('/api/users/current/', {
                method: 'PATCH',
                headers: { 'X-CSRFToken': getCsrfToken() },
                body: formData
            })
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'error') throw new Error(data.message);
                    document.getElementById('profile-image').src = data.profile_image;
                    document.getElementById('profile-image').style.display = 'block';
                    showNotification('تصویر پروفایل به‌روزرسانی شد', 'success');
                })
                .catch(error => {
                    showNotification(`خطا در آپلود تصویر: ${error.message}`, 'error');
                });
        }

        function getCsrfToken() {
            return document.querySelector('input[name="csrfmiddlewaretoken"]')?.value || '';
        }

        function showNotification(message, type = 'info') {
            const notification = document.createElement('div');
            notification.className = 'notification fixed top-4 left-4 bg-gray-900 text-white p-4 rounded-lg shadow-xl z-[1001]';
            notification.textContent = message;
            document.body.appendChild(notification);
            setTimeout(() => notification.remove(), 3000);
        }

        function enterChat() {
            const username = document.getElementById('username').value.trim();
            const displayName = document.getElementById('display_name').value.trim();
            const password = document.getElementById('password').value.trim();
            if (!username || !password) {
                showNotification('نام کاربری و رمز عبور الزامی است', 'error');
                return;
            }
            fetch('/api/users/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCsrfToken()
                },
                body: JSON.stringify({ username, display_name: displayName, password })
            })
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'error') throw new Error(data.message);
                    currentUser = data.display_name || username;
                    currentUserId = data.user_id;
                    document.getElementById('auth-container').style.display = 'none';
                    document.getElementById('chat-container').style.display = 'flex';
                    document.getElementById('current-chat').textContent = `چت گروهی - ${currentUser}`;
                    fetchGroups();
                    fetchChattedUsers();
                    startPolling();
                })
                .catch(error => {
                    showNotification(`خطا در ورود: ${error.message}`, 'error');
                });
        }

        function startPolling() {
            if (pollingInterval) clearInterval(pollingInterval);
            pollingInterval = setInterval(fetchMessages, 2000);
        }

        function fetchMessages() {
            let url = `/api/messages/?last_message_id=${lastMessageId}`;
            if (currentTab === 'group' && currentGroupId) {
                url += `&group_id=${currentGroupId}`;
            } else if (currentTab === 'private' && currentPrivateUserId) {
                url += `&recipient_id=${currentPrivateUserId}`;
            }
            fetch(url)
                .then(response => response.json())
                .then(messages => {
                    if (!Array.isArray(messages)) return;
                    const messagesContainer = document.getElementById('chat-messages');
                    messages.forEach(message => {
                        if (!message.id || !message.sender) return;
                        addMessage(message);
                        lastMessageId = Math.max(lastMessageId, message.id);
                    });
                    messagesContainer.scrollTop = messagesContainer.scrollHeight;
                })
                .catch(error => {
                    showNotification(`خطا در دریافت پیام‌ها: ${error.message}`, 'error');
                });
        }

        function fetchUsers(query = '') {
            let url = '/api/users/';
            if (query) url += `?search=${encodeURIComponent(query)}`;
            fetch(url)
                .then(response => response.json())
                .then(data => {
                    if (!data.users) return;
                    data.users.sort((a, b) => b.is_online - a.is_online);
                    updateUsersList(data.users);
                })
                .catch(error => {
                    showNotification('خطا در دریافت کاربران', 'error');
                });
        }

        function fetchGroups() {
            fetch('/api/groups/')
                .then(response => response.json())
                .then(groups => {
                    if (!Array.isArray(groups)) return;
                    const groupsList = document.getElementById('groups-list');
                    groupsList.innerHTML = '';
                    groups.forEach(group => {
                        const groupElement = document.createElement('div');
                        groupElement.className = 'sidebar-item p-2 rounded-lg cursor-pointer transition-all duration-200';
                        const avatarContent = group.image ? `<img src="${group.image}" class="w-full h-full rounded-full" />` : group.name.charAt(0);
                        groupElement.innerHTML = `
                            <div class="flex items-center gap-3">
                                <div class="w-10 h-10 sm:w-12 sm:h-12 bg-indigo-600 text-white flex items-center justify-center rounded-full">${avatarContent}</div>
                                <div class="text-white text-sm sm:text-base">${group.name}</div>
                            </div>
                        `;
                        groupElement.onclick = () => startGroupChat(group.id, group.name);
                        groupsList.appendChild(groupElement);
                    });
                })
                .catch(error => {
                    showNotification('خطا در دریافت گروه‌ها', 'error');
                });
        }

        function fetchGroupSearch(query = '') {
            let url = '/api/groups/search/';
            if (query) url += `?search=${encodeURIComponent(query)}`;
            fetch(url)
                .then(response => response.json())
                .then(data => {
                    if (!data.groups) return;
                    const searchGroupsList = document.getElementById('search-groups-list');
                    searchGroupsList.innerHTML = '';
                    data.groups.forEach(group => {
                        const groupElement = document.createElement('div');
                        groupElement.className = 'sidebar-item p-2 rounded-lg cursor-pointer transition-all duration-200';
                        const avatarContent = group.image ? `<img src="${group.image}" class="w-full h-full rounded-full" />` : group.name.charAt(0);
                        groupElement.innerHTML = `
                            <div class="flex items-center gap-3 justify-between">
                                <div class="flex items-center gap-3">
                                    <div class="w-10 h-10 sm:w-12 sm:h-12 bg-indigo-600 text-white flex items-center justify-center rounded-full">${avatarContent}</div>
                                    <div class="text-white text-sm sm:text-base">${group.name} (ID: ${group.id})</div>
                                </div>
                                <button class="p-1 sm:p-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 text-xs sm:text-sm" onclick="joinGroupFromSearch(${group.id}, '${group.name}')">پیوستن</button>
                            </div>
                        `;
                        searchGroupsList.appendChild(groupElement);
                    });
                })
                .catch(error => {
                    showNotification('خطا در جستجوی گروه‌ها', 'error');
                });
        }

        function joinGroupFromSearch(groupId, groupName) {
            document.getElementById('join-group-id').value = groupId;
            document.getElementById('join-group-modal').style.display = 'flex';
        }

        function fetchChattedUsers() {
            fetch('/api/users/chatted/')
                .then(response => response.json())
                .then(data => {
                    if (!data.users) return;
                    const profilesList = document.getElementById('profiles-list');
                    profilesList.innerHTML = '';
                    data.users.forEach(user => {
                        const userElement = document.createElement('div');
                        userElement.className = 'sidebar-item p-2 rounded-lg cursor-pointer transition-all duration-200';
                        const avatarContent = user.profile_image ? `<img src="${user.profile_image}" class="w-full h-full rounded-full" />` : (user.display_name || user.username).charAt(0);
                        userElement.innerHTML = `
                            <div class="flex items-center gap-3 justify-between">
                                <div class="flex items-center gap-3">
                                    <div class="w-10 h-10 sm:w-12 sm:h-12 bg-indigo-600 text-white flex items-center justify-center rounded-full">${avatarContent}</div>
                                    <div class="text-white text-sm sm:text-base">${user.display_name || user.username}</div>
                                </div>
                                <span class="w-2 h-2 sm:w-3 sm:h-3 rounded-full ${user.is_online ? 'bg-green-500' : 'bg-red-500'}"></span>
                            </div>
                        `;
                        userElement.onclick = () => startPrivateChat(user.id, user.display_name || user.username);
                        profilesList.appendChild(userElement);
                    });
                })
                .catch(error => {
                    showNotification('خطا در دریافت پروف‌ها', 'error');
                });
        }

        function updateUsersList(users) {
            const profilesList = document.getElementById('profiles-list');
            profileslify.innerHTML = '';
            users.forEach(user => {
                if (user.id !== currentUserId) {
                    const userElement = document.createElement('div');
                    userElement.className = 'sidebar-item p-2 rounded-lg cursor-pointer transition-all duration-200';
                    const avatarContent = user.profile_image ? `<img src="${user.profile_image}" class="w-full h-full rounded-full" />` : (user.display_name || user.username).charAt(0);
                    userElement.innerHTML = `
                        <div class="flex items-center gap-3 justify-between">
                            <div class="flex items-center gap-3">
                                <div class="w-10 h-10 sm:w-12 sm:h-12 bg-indigo-600 text-white flex items-center justify-center rounded-full">${avatarContent}</div>
                                <div class="text-white text-sm sm:text-base">${user.display_name || user.username}</div>
                            </div>
                            <span class="w-2 h-2 sm:w-3 sm:h-3 rounded-full ${user.is_online ? 'bg-green-500' : 'bg-red-500'}"></span>
                        </div>
                    `;
                    userElement.onclick = () => startPrivateChat(user.id, user.display_name || user.username);
                    profilesList.appendChild(userElement);
                }
            });
        }

        function addMessage(message) {
            if (!message.sender) return;
            const messagesContainer = document.getElementById('chat-messages');
            const messageDiv = document.createElement('div');
            messageDiv.className = 'message mb-4 max-w-[80%] sm:max-w-[70%]';
            const time = new Date(message.timestamp);
            const timeStr = time.toLocaleTimeString('fa-IR', { hour: '2-digit', minute: '2-digit' });
            messageDiv.innerHTML = `
                <div class="flex justify-between text-xs sm:text-sm text-gray-400 mb-1">
                    <span class="message-username">${message.sender.display_name || message.sender.username}</span>
                    <span class="message-time">${timeStr}</span>
                </div>
                <div class="message-bubble p-3 text-white shadow-md text-sm sm:text-base">${message.content}</div>
            `;
            if (message.files && message.files.length > 0) {
                message.files.forEach(file => {
                    const fileElement = document.createElement('div');
                    if (file.file_type === 'image') {
                        fileElement.innerHTML = `<img src="${file.file}" class="max-w-32 sm:max-w-48 mt-2 rounded-lg" />`;
                    } else {
                        fileElement.innerHTML = `<a href="${file.file}" target="_blank" class="text-indigo-400 hover:underline text-xs sm:text-sm">دانلود فایل</a>`;
                    }
                    messageDiv.appendChild(fileElement);
                });
            }
            messagesContainer.appendChild(messageDiv);
        }

        function sendMessage() {
            const messageInput = document.getElementById('message-input');
            const message = messageInput.value.trim();
            if (!message) {
                showNotification('لطفاً پیامی بنویسید', 'error');
                return;
            }
            const data = { content: message };
            if (currentTab === 'group' && currentGroupId) {
                data.group_id = currentGroupId;
            } else if (currentTab === 'private' && currentPrivateUserId) {
                data.recipient_id = currentPrivateUserId;
            }
            fetch('/api/messages/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCsrfToken()
                },
                body: JSON.stringify(data)
            })
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'error') throw new Error(data.message);
                    messageInput.value = '';
                    fetchMessages();
                })
                .catch(error => {
                    showNotification(`خطا در ارسال پیام: ${error.message}`, 'error');
                });
        }

        function sendMessageWithFiles(fileUrls) {
            const messageInput = document.getElementById('message-input');
            const data = { content: messageInput.value.trim(), file_urls: fileUrls };
            if (currentTab === 'group' && currentGroupId) {
                data.group_id = currentGroupId;
            } else if (currentTab === 'private' && currentPrivateUserId) {
                data.recipient_id = currentPrivateUserId;
            }
            fetch('/api/messages/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCsrfToken()
                },
                body: JSON.stringify(data)
            })
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'error') throw new Error(data.message);
                    messageInput.value = '';
                    showNotification('فایل ارسال شد', 'success');
                    fetchMessages();
                })
                .catch(error => {
                    showNotification(`خطا در ارسال فایل: ${error.message}`, 'error');
                });
        }

        function showProfile() {
            fetch('/api/users/current/')
                .then(response => response.json())
                .then(data => {
                    document.getElementById('profile-username').value = data.username;
                    document.getElementById('profile-display-name').value = data.display_name || '';
                    if (data.profile_image) {
                        document.getElementById('profile-image').src = data.profile_image;
                        document.getElementById('profile-image').style.display = 'block';
                    }
                    document.getElementById('profile-modal').style.display = 'flex';
                })
                .catch(error => {
                    showNotification('خطا در دریافت اطلاعات کاربر', 'error');
                });
        }

        function closeProfileModal() {
            document.getElementById('profile-modal').style.display = 'none';
        }

        function saveProfile() {
            const username = document.getElementById('profile-username').value.trim();
            const displayName = document.getElementById('profile-display-name').value.trim();
            const password = document.getElementById('profile-password').value.trim();
            if (!username) {
                showNotification('نام کاربری الزامی است', 'error');
                return;
            }
            const data = { username, display_name: displayName };
            if (password) data.password = password;
            fetch('/api/users/current/', {
                method: 'PATCH',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCsrfToken()
                },
                body: JSON.stringify(data)
            })
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'error') throw new Error(data.message);
                    currentUser = data.display_name || data.username;
                    showNotification('پروفایل به‌روزرسانی شد', 'success');
                    closeProfileModal();
                })
                .catch(error => {
                    showNotification(`خطا در به‌روزرسانی: ${error.message}`, 'error');
                });
        }

        function logout() {
            fetch('/api/users/logout/', {
                method: 'POST',
                headers: { 'X-CSRFToken': getCsrfToken() }
            })
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'error') throw new Error(data.message);
                    if (pollingInterval) clearInterval(pollingInterval);
                    window.location.reload();
                })
                .catch(error => {
                    showNotification(`خطا در خروج: ${error.message}`, 'error');
                });
        }

        function startPrivateChat(userId, username) {
            currentTab = 'private';
            currentPrivateUserId = userId;
            currentGroupId = null;
            document.getElementById('current-chat').textContent = `چت با ${username}`;
            document.getElementById('chat-messages').innerHTML = `<div class="text-center text-gray-400 p-4 rounded-lg bg-gray-900 text-sm sm:text-base">چت خصوصی با ${username}</div>`;
            lastMessageId = 0;
            fetchMessages();
        }

        function startGroupChat(groupId, groupName) {
            currentTab = 'group';
            currentGroupId = groupId;
            currentPrivateUserId = null;
            document.getElementById('current-chat').textContent = `گروه ${groupName}`;
            document.getElementById('chat-messages').innerHTML = `<div class="text-center text-gray-400 p-4 rounded-lg bg-gray-900 text-sm sm:text-base">چت گروهی: ${groupName}</div>`;
            lastMessageId = 0;
            fetchMessages();
        }

        function openGroupModal() {
            document.getElementById('group-modal').style.display = 'flex';
            document.getElementById('group-name').value = '';
            document.getElementById('group-description').value = '';
            document.getElementById('group-password').value = '';
            document.getElementById('group-image-input').value = '';
        }

        function closeGroupModal() {
            document.getElementById('group-modal').style.display = 'none';
        }

        function joinGroup() {
            const groupId = document.getElementById('join-group-id').value.trim();
            const password = document.getElementById('join-group-password').value.trim();
            if (!groupId) {
                showNotification('شناسه گروه الزامی است', 'error');
                return;
            }
            fetch('/api/groups/join/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCsrfToken()
                },
                body: JSON.stringify({ group_id: groupId, password })
            })
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'error') throw new Error(data.message);
                    document.getElementById('join-group-modal').style.display = 'none';
                    showNotification('با موفقیت به گروه پیوستید', 'success');
                    fetchGroups();
                })
                .catch(error => {
                    showNotification(`خطا در پیوستن: ${error.message}`, 'error');
                });
        }

        function closeJoinGroupModal() {
            document.getElementById('join-group-modal').style.display = 'none';
        }

        document.getElementById('save-group-btn').addEventListener('click', () => {
            const name = document.getElementById('group-name').value.trim();
            const description = document.getElementById('group-description').value.trim();
            const password = document.getElementById('group-password').value.trim();
            const imageInput = document.getElementById('group-image-input');
            if (!name) {
                showNotification('نام گروه الزامی است', 'error');
                return;
            }
            const formData = new FormData();
            formData.append('name', name);
            formData.append('description', description);
            formData.append('password', password);
            formData.append('creator_id', currentUserId);
            if (imageInput.files[0]) {
                formData.append('image', imageInput.files[0]);
            }
            fetch('/api/groups/', {
                method: 'POST',
                headers: { 'X-CSRFToken': getCsrfToken() },
                body: formData
            })
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'error') throw new Error(data.message);
                    document.getElementById('group-modal').style.display = 'none';
                    showNotification('گروه با موفقیت ایجاد شد', 'success');
                    fetchGroups();
                })
                .catch(error => {
                    showNotification(`خطا در ایجاد گروه: ${error.message}`, 'error');
                });
        });
    </script>
</body>
</html>